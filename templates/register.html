{% extends "layout.html" %}

{% block title %}Register{% endblock %}

{% block content %}
<h2>Register</h2>

<div id="errorAlert" style="color:red; display:none;"></div>
<div id="successAlert" style="color:green; display:none;"></div>

<form id="registrationForm">
    <label>Username:</label><br>
    <input type="text" id="username" name="username"><br><br>

    <label>Email:</label><br>
    <input type="email" id="email" name="email"><br><br>

    <label>First Name:</label><br>
    <input type="text" id="first_name" name="first_name"><br><br>

    <label>Last Name:</label><br>
    <input type="text" id="last_name" name="last_name"><br><br>

    <label>Password:</label><br>
    <input type="password" id="password" name="password"><br><br>

    <label>Confirm Password:</label><br>
    <input type="password" id="confirm_password" name="confirm_password"><br><br>

    <button type="submit">Register</button>
</form>

<p>Already have an account? <a href="/login">Login</a></p>

<script>
// Grab alert elements FIRST (you were missing this!)
const errorAlert = document.getElementById("errorAlert");
const successAlert = document.getElementById("successAlert");

document.getElementById("registrationForm").addEventListener("submit", async function(event){
    event.preventDefault();

    // Clear alerts
    errorAlert.style.display = "none";
    successAlert.style.display = "none";

    // Passwords match check
    if (password.value !== confirm_password.value) {
        errorAlert.textContent = "Passwords do not match.";
        errorAlert.style.display = "block";
        return;
    }

    const data = {
        username: username.value.trim(),
        email: email.value.trim(),
        first_name: first_name.value.trim(),
        last_name: last_name.value.trim(),
        password: password.value,
        confirm_password: confirm_password.value
    };

    let result;
    let response;

    try {
        response = await fetch("/auth/register", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(data)
        });

        result = await response.json();
    } catch (e) {
        errorAlert.textContent = "Server connection error.";
        errorAlert.style.display = "block";
        return;
    }

    // Handle backend validation errors
    if (!response.ok) {
        let message = "Registration failed.";

        if (Array.isArray(result.detail)) {
            message = result.detail.map(item => item.msg).join("; ");
        } else if (typeof result.detail === "string") {
            message = result.detail;
        }

        errorAlert.textContent = message;
        errorAlert.style.display = "block";
        return;
    }

    // Success
    successAlert.textContent = "Registration successful! Redirecting...";
    successAlert.style.display = "block";

    setTimeout(() => window.location.href = "/login", 1500);
});
</script>

{% endblock %}
