{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<h2>Dashboard</h2>

<p id="welcomeMsg"></p>

<button id="logoutBtn">Logout</button>

<hr><br>

<h3>Create New Calculation</h3>

<div id="errorAlert" style="color:red; display:none;"></div>
<div id="successAlert" style="color:green; display:none;"></div>

<form id="calcForm">
    <label>Type:</label><br>
    <select id="calcType">
        <option value="addition">Addition</option>
        <option value="subtraction">Subtraction</option>
        <option value="multiplication">Multiplication</option>
        <option value="division">Division</option>
    </select><br><br>

    <label>Numbers (comma separated):</label><br>
    <input type="text" id="calcInputs"><br><br>

    <button type="submit">Calculate</button>
</form>

<hr><br>

<h3>Your Calculations</h3>

<table border="1" cellpadding="5">
    <thead>
        <tr>
            <th>Type</th>
            <th>Inputs</th>
            <th>Result</th>
            <th>Date</th>
            <th>Delete</th>
        </tr>
    </thead>
    <tbody id="calcTable"></tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const token = localStorage.getItem("access_token");
    if (!token) {
        window.location.href = "/login";
        return;
    }

    welcomeMsg.textContent = "Welcome, " + localStorage.getItem("username") + "!";

    async function loadCalculations() {
        const response = await fetch("/calculations", {
            headers: { "Authorization": "Bearer " + token }
        });

        if (!response.ok) return;

        const data = await response.json();
        calcTable.innerHTML = "";

        if (data.length === 0) {
            calcTable.innerHTML = `
                <tr><td colspan="5">No calculations yet.</td></tr>
            `;
            return;
        }

        data.forEach(calc => {
            const row = document.createElement("tr");

            row.innerHTML = `
                <td>${calc.type}</td>
                <td>${calc.inputs.join(", ")}</td>
                <td>${calc.result}</td>
                <td>${new Date(calc.created_at).toLocaleString()}</td>
                <td><button data-id="${calc.id}" class="deleteBtn">Delete</button></td>
            `;

            calcTable.appendChild(row);
        });

        document.querySelectorAll(".deleteBtn").forEach(btn => {
            btn.onclick = async () => {
                const id = btn.dataset.id;

                await fetch("/calculations/" + id, {
                    method: "DELETE",
                    headers: { "Authorization": "Bearer " + token }
                });

                loadCalculations();
            };
        });
    }

    calcForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const inputs = calcInputs.value.split(",").map(n => parseFloat(n.trim()));

        if (inputs.some(isNaN)) {
            errorAlert.textContent = "Enter valid numbers.";
            errorAlert.style.display = "block";
            return;
        }

        const response = await fetch("/calculations", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({
                type: calcType.value,
                inputs: inputs
            })
        });

        if (!response.ok) {
            errorAlert.textContent = "Error creating calculation.";
            errorAlert.style.display = "block";
            return;
        }

        successAlert.textContent = "Calculation added!";
        successAlert.style.display = "block";
        loadCalculations();
    });

    logoutBtn.onclick = () => {
        localStorage.clear();
        window.location.href = "/login";
    };

    loadCalculations();
});
</script>
{% endblock %}
