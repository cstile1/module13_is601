{% extends "layout.html" %}

{% block title %}Login{% endblock %}

{% block content %}
<h2>Login</h2>

<div id="errorAlert" style="color:red; display:none;"></div>

<form id="loginForm">
    <label>Username:</label><br>
    <input type="text" id="username" name="username"><br><br>

    <label>Password:</label><br>
    <input type="password" id="password" name="password"><br><br>

    <button type="submit">Login</button>
</form>

<p>Don't have an account? <a href="/register">Register</a></p>

<script>
document.getElementById("loginForm").addEventListener("submit", async function(event){
    event.preventDefault();

    const errorBox = document.getElementById("errorAlert");
    errorBox.style.display = "none";

    const data = {
        username: username.value.trim(),
        password: password.value
    };

    let response;
    let text;
    let result;

    try {
        response = await fetch("/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        // read raw text first
        text = await response.text();

        // try to parse JSON safely
        try {
            result = JSON.parse(text);
        } catch {
            // backend returned plain text (like "Internal Server Error")
            errorBox.textContent = text;
            errorBox.style.display = "block";
            return;
        }

    } catch (e) {
        errorBox.textContent = "Server connection error.";
        errorBox.style.display = "block";
        return;
    }

    if (!response.ok) {
        errorBox.textContent = result.detail || "Invalid login.";
        errorBox.style.display = "block";
        return;
    }

    // SUCCESS
    localStorage.setItem("access_token", result.access_token);
    localStorage.setItem("username", result.username);
    window.location.href = "/";
});
</script>

{% endblock %}
